/*!

	Teledraw Canvas
	Version 0.11.2 (http://semver.org/)
	Copyright 2012 Cameron Lakenen
	
	Permission is hereby granted, free of charge, to any person obtaining
	a copy of this software and associated documentation files (the
	"Software"), to deal in the Software without restriction, including
	without limitation the rights to use, copy, modify, merge, publish,
	distribute, sublicense, and/or sell copies of the Software, and to
	permit persons to whom the Software is furnished to do so, subject to
	the following conditions:
	
	The above copyright notice and this permission notice shall be
	included in all copies or substantial portions of the Software.
	
	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
	EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
	MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
	NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
	LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
	OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
	WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

**/
(function(){var d=true,k=false,q=null,u,b=Math,j=b.abs,t=b.sqrt,p=b.floor,r=b.round,l=b.min,n=b.max,c=b.pow,g=function(v){return c(v,2)},h;TeledrawCanvas=function(v,w){return new TeledrawCanvas.api(v,w)};stackBlurCanvasRGBA=(function(){var v=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259];var y=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];var x=function(G,aj){if(isNaN(aj)||aj<1){return}aj|=0;var aa=0,Y=0,z=G.width,B=G.height;var au=G.getContext("2d");var ao;try{try{ao=au.getImageData(aa,Y,z,B)}catch(at){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");ao=au.getImageData(aa,Y,z,B)}catch(at){alert("Cannot access local image");throw new Error("unable to access local image data: "+at);return}}}catch(at){alert("Cannot access image");throw new Error("unable to access image data: "+at)}var F=ao.data;var ah,ag,aq,an,O,R,K,D,E,X,am,N,Z,V,A,ad,ai,P,M,J,Q,S,T,ac;var ar=aj+aj+1;var ae=z<<2;var L=z-1;var al=B-1;var I=aj+1;var ak=I*(I+1)/2;var ab=new w();var W=ab;for(aq=1;aq<ar;aq++){W=W.next=new w();if(aq==I){var H=W}}W.next=ab;var ap=null;var af=null;K=R=0;var U=v[aj];var C=y[aj];for(ag=0;ag<B;ag++){ad=ai=P=M=D=E=X=am=0;N=I*(J=F[R]);Z=I*(Q=F[R+1]);V=I*(S=F[R+2]);A=I*(T=F[R+3]);D+=ak*J;E+=ak*Q;X+=ak*S;am+=ak*T;W=ab;for(aq=0;aq<I;aq++){W.r=J;W.g=Q;W.b=S;W.a=T;W=W.next}for(aq=1;aq<I;aq++){an=R+((L<aq?L:aq)<<2);D+=(W.r=(J=F[an]))*(ac=I-aq);E+=(W.g=(Q=F[an+1]))*ac;X+=(W.b=(S=F[an+2]))*ac;am+=(W.a=(T=F[an+3]))*ac;ad+=J;ai+=Q;P+=S;M+=T;W=W.next}ap=ab;af=H;for(ah=0;ah<z;ah++){F[R+3]=T=(am*U)>>C;if(T!=0){T=255/T;F[R]=((D*U)>>C)*T;F[R+1]=((E*U)>>C)*T;F[R+2]=((X*U)>>C)*T}else{F[R]=F[R+1]=F[R+2]=0}D-=N;E-=Z;X-=V;am-=A;N-=ap.r;Z-=ap.g;V-=ap.b;A-=ap.a;an=(K+((an=ah+aj+1)<L?an:L))<<2;ad+=(ap.r=F[an]);ai+=(ap.g=F[an+1]);P+=(ap.b=F[an+2]);M+=(ap.a=F[an+3]);D+=ad;E+=ai;X+=P;am+=M;ap=ap.next;N+=(J=af.r);Z+=(Q=af.g);V+=(S=af.b);A+=(T=af.a);ad-=J;ai-=Q;P-=S;M-=T;af=af.next;R+=4}K+=z}for(ah=0;ah<z;ah++){ai=P=M=ad=E=X=am=D=0;R=ah<<2;N=I*(J=F[R]);Z=I*(Q=F[R+1]);V=I*(S=F[R+2]);A=I*(T=F[R+3]);D+=ak*J;E+=ak*Q;X+=ak*S;am+=ak*T;W=ab;for(aq=0;aq<I;aq++){W.r=J;W.g=Q;W.b=S;W.a=T;W=W.next}O=z;for(aq=1;aq<=aj;aq++){R=(O+ah)<<2;D+=(W.r=(J=F[R]))*(ac=I-aq);E+=(W.g=(Q=F[R+1]))*ac;X+=(W.b=(S=F[R+2]))*ac;am+=(W.a=(T=F[R+3]))*ac;ad+=J;ai+=Q;P+=S;M+=T;W=W.next;if(aq<al){O+=z}}R=ah;ap=ab;af=H;for(ag=0;ag<B;ag++){an=R<<2;F[an+3]=T=(am*U)>>C;if(T>0){T=255/T;F[an]=((D*U)>>C)*T;F[an+1]=((E*U)>>C)*T;F[an+2]=((X*U)>>C)*T}else{F[an]=F[an+1]=F[an+2]=0}D-=N;E-=Z;X-=V;am-=A;N-=ap.r;Z-=ap.g;V-=ap.b;A-=ap.a;an=(ah+(((an=ag+I)<al?an:al)*z))<<2;D+=(ad+=(ap.r=F[an]));E+=(ai+=(ap.g=F[an+1]));X+=(P+=(ap.b=F[an+2]));am+=(M+=(ap.a=F[an+3]));ap=ap.next;N+=(J=af.r);Z+=(Q=af.g);V+=(S=af.b);A+=(T=af.a);ad-=J;ai-=Q;P-=S;M-=T;af=af.next;R+=z}}au.putImageData(ao,aa,Y)};function w(){this.r=0;this.g=0;this.b=0;this.a=0;this.next=null}return x})();Events=(function(){var x=Array.prototype.slice;var w=/\s+/;var v={on:function(B,F,A){var z,D,C,y,E;if(!F){return this}B=B.split(w);z=this._callbacks||(this._callbacks={});while(D=B.shift()){E=z[D];C=E?E.tail:{};C.next=y={};C.context=A;C.callback=F;z[D]={tail:y,next:E?E.next:C}}return this},off:function(F,D,z){var y,G,A,C,B,E;if(!(G=this._callbacks)){return}if(!(F||D||z)){delete this._callbacks;return this}F=F?F.split(w):_.keys(G);while(y=F.shift()){A=G[y];delete G[y];if(!A||!(D||z)){continue}C=A.tail;while((A=A.next)!==C){B=A.callback;E=A.context;if((D&&B!==D)||(z&&E!==z)){this.on(y,B,E)}}}return this},trigger:function(B){var F,E,A,z,y,D,C;if(!(A=this._callbacks)){return this}D=A.all;B=B.split(w);C=x.call(arguments,1);while(F=B.shift()){if(E=A[F]){z=E.tail;while((E=E.next)!==z){E.callback.apply(E.context||this,C)}}if(E=D){z=E.tail;y=[F].concat(C);while((E=E.next)!==z){E.callback.apply(E.context||this,y)}}}return this}};v.bind=v.on;v.unbind=v.off;return v})();function m(x,z,y){if(z==="mouseenter"||z==="mouseleave"){var v=z==="mouseenter",A=v?"fromElement":"toElement";z=v?"mouseover":"mouseout";m(x,z,function(D){D=D||window.event;var C=D.target||D.srcElement,B=D.relatedTarget||D[A];if((x===C||e(x,C))&&!e(x,B)){return y.apply(this,arguments)}});return}if(x.addEventListener){x.addEventListener(z,y,false)}else{if(!y.$$guid){y.$$guid=m.guid++}if(!x.events){x.events={}}var w=x.events[z];if(!w){w=x.events[z]={};if(x["on"+z]){w[0]=x["on"+z]}}w[y.$$guid]=y;x["on"+z]=f}}m.guid=1;function o(v,x,w){if(v.removeEventListener){v.removeEventListener(x,w,false)}else{if(v.events&&v.events[x]){delete v.events[x][w.$$guid]}}}function f(y){var x=true;y=y||s(((this.ownerDocument||this.document||this).parentWindow||window).event);var v=this.events[y.type];for(var w in v){this.$$handleEvent=v[w];if(this.$$handleEvent(y)===false){x=false}}return x}function s(v){v.preventDefault=s.preventDefault;v.stopPropagation=s.stopPropagation;return v}s.preventDefault=function(){this.returnValue=false};s.stopPropagation=function(){this.cancelBubble=true};function e(v,w){return v.contains?v.contains(w):!!(v.compareDocumentPosition(w)&16)}(function(){var P=this;var E=P._;var X={};var W=Array.prototype,A=Object.prototype,K=Function.prototype;var H=W.slice,T=W.unshift,x=A.toString,C=A.hasOwnProperty;var af=W.forEach,J=W.map,Y=W.reduce,w=W.reduceRight,v=W.filter,U=W.every,I=W.some,G=W.indexOf,F=W.lastIndexOf,M=Array.isArray,z=Object.keys,Z=K.bind;var ag=function(ah){return new N(ah)};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=ag}exports._=ag}else{P._=ag}ag.VERSION="1.3.3";var ac=ag.each=ag.forEach=function(am,al,ak){if(am==null){return}if(af&&am.forEach===af){am.forEach(al,ak)}else{if(am.length===+am.length){for(var aj=0,ah=am.length;aj<ah;aj++){if(aj in am&&al.call(ak,am[aj],aj,am)===X){return}}}else{for(var ai in am){if(ag.has(am,ai)){if(al.call(ak,am[ai],ai,am)===X){return}}}}}};ag.map=ag.collect=function(ak,aj,ai){var ah=[];if(ak==null){return ah}if(J&&ak.map===J){return ak.map(aj,ai)}ac(ak,function(an,al,am){ah[ah.length]=aj.call(ai,an,al,am)});if(ak.length===+ak.length){ah.length=ak.length}return ah};ag.reduce=ag.foldl=ag.inject=function(al,ak,ah,aj){var ai=arguments.length>2;if(al==null){al=[]}if(Y&&al.reduce===Y){if(aj){ak=ag.bind(ak,aj)}return ai?al.reduce(ak,ah):al.reduce(ak)}ac(al,function(ao,am,an){if(!ai){ah=ao;ai=true}else{ah=ak.call(aj,ah,ao,am,an)}});if(!ai){throw new TypeError("Reduce of empty array with no initial value")}return ah};ag.reduceRight=ag.foldr=function(al,ak,ah,aj){var ai=arguments.length>2;if(al==null){al=[]}if(w&&al.reduceRight===w){if(aj){ak=ag.bind(ak,aj)}return ai?al.reduceRight(ak,ah):al.reduceRight(ak)}var am=ag.toArray(al).reverse();if(aj&&!ai){ak=ag.bind(ak,aj)}return ai?ag.reduce(am,ak,ah,aj):ag.reduce(am,ak)};ag.find=ag.detect=function(ak,aj,ai){var ah;S(ak,function(an,al,am){if(aj.call(ai,an,al,am)){ah=an;return true}});return ah};ag.filter=ag.select=function(ak,aj,ai){var ah=[];if(ak==null){return ah}if(v&&ak.filter===v){return ak.filter(aj,ai)}ac(ak,function(an,al,am){if(aj.call(ai,an,al,am)){ah[ah.length]=an}});return ah};ag.reject=function(ak,aj,ai){var ah=[];if(ak==null){return ah}ac(ak,function(an,al,am){if(!aj.call(ai,an,al,am)){ah[ah.length]=an}});return ah};ag.every=ag.all=function(ak,aj,ai){var ah=true;if(ak==null){return ah}if(U&&ak.every===U){return ak.every(aj,ai)}ac(ak,function(an,al,am){if(!(ah=ah&&aj.call(ai,an,al,am))){return X}});return !!ah};var S=ag.some=ag.any=function(ak,aj,ai){aj||(aj=ag.identity);var ah=false;if(ak==null){return ah}if(I&&ak.some===I){return ak.some(aj,ai)}ac(ak,function(an,al,am){if(ah||(ah=aj.call(ai,an,al,am))){return X}});return !!ah};ag.include=ag.contains=function(aj,ai){var ah=false;if(aj==null){return ah}if(G&&aj.indexOf===G){return aj.indexOf(ai)!=-1}ah=S(aj,function(ak){return ak===ai});return ah};ag.invoke=function(ai,aj){var ah=H.call(arguments,2);return ag.map(ai,function(ak){return(ag.isFunction(aj)?aj||ak:ak[aj]).apply(ak,ah)})};ag.pluck=function(ai,ah){return ag.map(ai,function(aj){return aj[ah]})};ag.max=function(ak,aj,ai){if(!aj&&ag.isArray(ak)&&ak[0]===+ak[0]){return Math.max.apply(Math,ak)}if(!aj&&ag.isEmpty(ak)){return -Infinity}var ah={computed:-Infinity};ac(ak,function(ao,al,an){var am=aj?aj.call(ai,ao,al,an):ao;am>=ah.computed&&(ah={value:ao,computed:am})});return ah.value};ag.min=function(ak,aj,ai){if(!aj&&ag.isArray(ak)&&ak[0]===+ak[0]){return Math.min.apply(Math,ak)}if(!aj&&ag.isEmpty(ak)){return Infinity}var ah={computed:Infinity};ac(ak,function(ao,al,an){var am=aj?aj.call(ai,ao,al,an):ao;am<ah.computed&&(ah={value:ao,computed:am})});return ah.value};ag.shuffle=function(aj){var ah=[],ai;ac(aj,function(am,ak,al){ai=Math.floor(Math.random()*(ak+1));ah[ak]=ah[ai];ah[ai]=am});return ah};ag.sortBy=function(aj,ak,ah){var ai=ag.isFunction(ak)?ak:function(al){return al[ak]};return ag.pluck(ag.map(aj,function(an,al,am){return{value:an,criteria:ai.call(ah,an,al,am)}}).sort(function(ao,an){var am=ao.criteria,al=an.criteria;if(am===void 0){return 1}if(al===void 0){return -1}return am<al?-1:am>al?1:0}),"value")};ag.groupBy=function(aj,ak){var ah={};var ai=ag.isFunction(ak)?ak:function(al){return al[ak]};ac(aj,function(an,al){var am=ai(an,al);(ah[am]||(ah[am]=[])).push(an)});return ah};ag.sortedIndex=function(am,al,aj){aj||(aj=ag.identity);var ah=0,ak=am.length;while(ah<ak){var ai=(ah+ak)>>1;aj(am[ai])<aj(al)?ah=ai+1:ak=ai}return ah};ag.toArray=function(ah){if(!ah){return[]}if(ag.isArray(ah)){return H.call(ah)}if(ag.isArguments(ah)){return H.call(ah)}if(ah.toArray&&ag.isFunction(ah.toArray)){return ah.toArray()}return ag.values(ah)};ag.size=function(ah){return ag.isArray(ah)?ah.length:ag.keys(ah).length};ag.first=ag.head=ag.take=function(aj,ai,ah){return(ai!=null)&&!ah?H.call(aj,0,ai):aj[0]};ag.initial=function(aj,ai,ah){return H.call(aj,0,aj.length-((ai==null)||ah?1:ai))};ag.last=function(aj,ai,ah){if((ai!=null)&&!ah){return H.call(aj,Math.max(aj.length-ai,0))}else{return aj[aj.length-1]}};ag.rest=ag.tail=function(aj,ah,ai){return H.call(aj,(ah==null)||ai?1:ah)};ag.compact=function(ah){return ag.filter(ah,function(ai){return !!ai})};ag.flatten=function(ai,ah){return ag.reduce(ai,function(aj,ak){if(ag.isArray(ak)){return aj.concat(ah?ak:ag.flatten(ak))}aj[aj.length]=ak;return aj},[])};ag.without=function(ah){return ag.difference(ah,H.call(arguments,1))};ag.uniq=ag.unique=function(al,ak,aj){var ah=aj?ag.map(al,aj):al;var ai=[];if(al.length<3){ak=true}ag.reduce(ah,function(am,ao,an){if(ak?ag.last(am)!==ao||!am.length:!ag.include(am,ao)){am.push(ao);ai.push(al[an])}return am},[]);return ai};ag.union=function(){return ag.uniq(ag.flatten(arguments,true))};ag.intersection=ag.intersect=function(ai){var ah=H.call(arguments,1);return ag.filter(ag.uniq(ai),function(aj){return ag.every(ah,function(ak){return ag.indexOf(ak,aj)>=0})})};ag.difference=function(ai){var ah=ag.flatten(H.call(arguments,1),true);return ag.filter(ai,function(aj){return !ag.include(ah,aj)})};ag.zip=function(){var ah=H.call(arguments);var ak=ag.max(ag.pluck(ah,"length"));var aj=new Array(ak);for(var ai=0;ai<ak;ai++){aj[ai]=ag.pluck(ah,""+ai)}return aj};ag.indexOf=function(al,aj,ak){if(al==null){return -1}var ai,ah;if(ak){ai=ag.sortedIndex(al,aj);return al[ai]===aj?ai:-1}if(G&&al.indexOf===G){return al.indexOf(aj)}for(ai=0,ah=al.length;ai<ah;ai++){if(ai in al&&al[ai]===aj){return ai}}return -1};ag.lastIndexOf=function(aj,ai){if(aj==null){return -1}if(F&&aj.lastIndexOf===F){return aj.lastIndexOf(ai)}var ah=aj.length;while(ah--){if(ah in aj&&aj[ah]===ai){return ah}}return -1};ag.range=function(am,ak,al){if(arguments.length<=1){ak=am||0;am=0}al=arguments[2]||1;var ai=Math.max(Math.ceil((ak-am)/al),0);var ah=0;var aj=new Array(ai);while(ah<ai){aj[ah++]=am;am+=al}return aj};var aa=function(){};ag.bind=function y(ak,ai){var aj,ah;if(ak.bind===Z&&Z){return Z.apply(ak,H.call(arguments,1))}if(!ag.isFunction(ak)){throw new TypeError}ah=H.call(arguments,2);return aj=function(){if(!(this instanceof aj)){return ak.apply(ai,ah.concat(H.call(arguments)))}aa.prototype=ak.prototype;var am=new aa;var al=ak.apply(am,ah.concat(H.call(arguments)));if(Object(al)===al){return al}return am}};ag.bindAll=function(ai){var ah=H.call(arguments,1);if(ah.length==0){ah=ag.functions(ai)}ac(ah,function(aj){ai[aj]=ag.bind(ai[aj],ai)});return ai};ag.memoize=function(aj,ai){var ah={};ai||(ai=ag.identity);return function(){var ak=ai.apply(this,arguments);return ag.has(ah,ak)?ah[ak]:(ah[ak]=aj.apply(this,arguments))}};ag.delay=function(ai,aj){var ah=H.call(arguments,2);return setTimeout(function(){return ai.apply(null,ah)},aj)};ag.defer=function(ah){return ag.delay.apply(ag,[ah,1].concat(H.call(arguments,1)))};ag.throttle=function(aj,ak){var ai,am,an,ao,al,ap;var ah=ag.debounce(function(){al=ao=false},ak);return function(){ai=this;am=arguments;var aq=function(){an=null;if(al){aj.apply(ai,am)}ah()};if(!an){an=setTimeout(aq,ak)}if(ao){al=true}else{ap=aj.apply(ai,am)}ah();ao=true;return ap}};ag.debounce=function(ai,ak,ah){var aj;return function(){var an=this,am=arguments;var al=function(){aj=null;if(!ah){ai.apply(an,am)}};if(ah&&!aj){ai.apply(an,am)}clearTimeout(aj);aj=setTimeout(al,ak)}};ag.once=function(aj){var ah=false,ai;return function(){if(ah){return ai}ah=true;return ai=aj.apply(this,arguments)}};ag.wrap=function(ah,ai){return function(){var aj=[ah].concat(H.call(arguments,0));return ai.apply(this,aj)}};ag.compose=function(){var ah=arguments;return function(){var ai=arguments;for(var aj=ah.length-1;aj>=0;aj--){ai=[ah[aj].apply(this,ai)]}return ai[0]}};ag.after=function(ai,ah){if(ai<=0){return ah()}return function(){if(--ai<1){return ah.apply(this,arguments)}}};ag.keys=z||function(aj){if(aj!==Object(aj)){throw new TypeError("Invalid object")}var ai=[];for(var ah in aj){if(ag.has(aj,ah)){ai[ai.length]=ah}}return ai};ag.values=function(ah){return ag.map(ah,ag.identity)};ag.functions=ag.methods=function(aj){var ai=[];for(var ah in aj){if(ag.isFunction(aj[ah])){ai.push(ah)}}return ai.sort()};ag.extend=function(ah){ac(H.call(arguments,1),function(ai){for(var aj in ai){ah[aj]=ai[aj]}});return ah};ag.pick=function(ai){var ah={};ac(ag.flatten(H.call(arguments,1)),function(aj){if(aj in ai){ah[aj]=ai[aj]}});return ah};ag.defaults=function(ah){ac(H.call(arguments,1),function(ai){for(var aj in ai){if(ah[aj]==null){ah[aj]=ai[aj]}}});return ah};ag.clone=function(ah){if(!ag.isObject(ah)){return ah}return ag.isArray(ah)?ah.slice():ag.extend({},ah)};ag.tap=function(ai,ah){ah(ai);return ai};function ad(ak,aj,ai){if(ak===aj){return ak!==0||1/ak==1/aj}if(ak==null||aj==null){return ak===aj}if(ak._chain){ak=ak._wrapped}if(aj._chain){aj=aj._wrapped}if(ak.isEqual&&ag.isFunction(ak.isEqual)){return ak.isEqual(aj)}if(aj.isEqual&&ag.isFunction(aj.isEqual)){return aj.isEqual(ak)}var an=x.call(ak);if(an!=x.call(aj)){return false}switch(an){case"[object String]":return ak==String(aj);case"[object Number]":return ak!=+ak?aj!=+aj:(ak==0?1/ak==1/aj:ak==+aj);case"[object Date]":case"[object Boolean]":return +ak==+aj;case"[object RegExp]":return ak.source==aj.source&&ak.global==aj.global&&ak.multiline==aj.multiline&&ak.ignoreCase==aj.ignoreCase}if(typeof ak!="object"||typeof aj!="object"){return false}var ao=ai.length;while(ao--){if(ai[ao]==ak){return true}}ai.push(ak);var am=0,ah=true;if(an=="[object Array]"){am=ak.length;ah=am==aj.length;if(ah){while(am--){if(!(ah=am in ak==am in aj&&ad(ak[am],aj[am],ai))){break}}}}else{if("constructor" in ak!="constructor" in aj||ak.constructor!=aj.constructor){return false}for(var al in ak){if(ag.has(ak,al)){am++;if(!(ah=ag.has(aj,al)&&ad(ak[al],aj[al],ai))){break}}}if(ah){for(al in aj){if(ag.has(aj,al)&&!(am--)){break}}ah=!am}}ai.pop();return ah}ag.isEqual=function(ai,ah){return ad(ai,ah,[])};ag.isEmpty=function(ai){if(ai==null){return true}if(ag.isArray(ai)||ag.isString(ai)){return ai.length===0}for(var ah in ai){if(ag.has(ai,ah)){return false}}return true};ag.isElement=function(ah){return !!(ah&&ah.nodeType==1)};ag.isArray=M||function(ah){return x.call(ah)=="[object Array]"};ag.isObject=function(ah){return ah===Object(ah)};ag.isArguments=function(ah){return x.call(ah)=="[object Arguments]"};if(!ag.isArguments(arguments)){ag.isArguments=function(ah){return !!(ah&&ag.has(ah,"callee"))}}ag.isFunction=function(ah){return x.call(ah)=="[object Function]"};ag.isString=function(ah){return x.call(ah)=="[object String]"};ag.isNumber=function(ah){return x.call(ah)=="[object Number]"};ag.isFinite=function(ah){return ag.isNumber(ah)&&isFinite(ah)};ag.isNaN=function(ah){return ah!==ah};ag.isBoolean=function(ah){return ah===true||ah===false||x.call(ah)=="[object Boolean]"};ag.isDate=function(ah){return x.call(ah)=="[object Date]"};ag.isRegExp=function(ah){return x.call(ah)=="[object RegExp]"};ag.isNull=function(ah){return ah===null};ag.isUndefined=function(ah){return ah===void 0};ag.has=function(ai,ah){return C.call(ai,ah)};ag.noConflict=function(){P._=E;return this};ag.identity=function(ah){return ah};ag.times=function(ak,aj,ai){for(var ah=0;ah<ak;ah++){aj.call(ai,ah)}};ag.escape=function(ah){return(""+ah).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")};ag.result=function(ah,aj){if(ah==null){return null}var ai=ah[aj];return ag.isFunction(ai)?ai.call(ah):ai};ag.mixin=function(ah){ac(ag.functions(ah),function(ai){Q(ai,ag[ai]=ah[ai])})};var R=0;ag.uniqueId=function(ah){var ai=R++;return ah?ah+ai:ai};ag.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var O=/.^/;var B={"\\":"\\","'":"'",r:"\r",n:"\n",t:"\t",u2028:"\u2028",u2029:"\u2029"};for(var ab in B){B[B[ab]]=ab}var D=/\\|'|\r|\n|\t|\u2028|\u2029/g;var V=/\\(\\|'|r|n|t|u2028|u2029)/g;var ae=function(ah){return ah.replace(V,function(ai,aj){return B[aj]})};ag.template=function(am,al,aj){aj=ag.defaults(aj||{},ag.templateSettings);var ak="__p+='"+am.replace(D,function(an){return"\\"+B[an]}).replace(aj.escape||O,function(an,ao){return"'+\n_.escape("+ae(ao)+")+\n'"}).replace(aj.interpolate||O,function(an,ao){return"'+\n("+ae(ao)+")+\n'"}).replace(aj.evaluate||O,function(an,ao){return"';\n"+ae(ao)+"\n;__p+='"})+"';\n";if(!aj.variable){ak="with(obj||{}){\n"+ak+"}\n"}ak="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+ak+"return __p;\n";var ai=new Function(aj.variable||"obj","_",ak);if(al){return ai(al,ag)}var ah=function(an){return ai.call(this,an,ag)};ah.source="function("+(aj.variable||"obj")+"){\n"+ak+"}";return ah};ag.chain=function(ah){return ag(ah).chain()};var N=function(ah){this._wrapped=ah};ag.prototype=N.prototype;var L=function(ai,ah){return ah?ag(ai).chain():ai};var Q=function(ah,ai){N.prototype[ah]=function(){var aj=H.call(arguments);T.call(aj,this._wrapped);return L(ai.apply(ag,aj),this._chain)}};ag.mixin(ag);ac(["pop","push","reverse","shift","sort","splice","unshift"],function(ah){var ai=W[ah];N.prototype[ah]=function(){var aj=this._wrapped;ai.apply(aj,arguments);var ak=aj.length;if((ah=="shift"||ah=="splice")&&ak===0){delete aj[0]}return L(aj,this._chain)}});ac(["concat","join","slice"],function(ah){var ai=W[ah];N.prototype[ah]=function(){return L(ai.apply(this._wrapped,arguments),this._chain)}});N.prototype.chain=function(){this._chain=true;return this};N.prototype.value=function(){return this._wrapped}}).call(this);function a(v,A,w){if(v instanceof a){return a.create(v)}this.x=v||0;this.y=A||0;this.z=w||0}a.prototype.add=function(w){this.x+=w.x;this.y+=w.y;this.z+=w.z;return this};a.prototype.scale=function(v){this.x*=v;this.y*=v;this.z*=v;return this};a.prototype.direction=function(){return Math.atan2(this.y,this.x)};a.prototype.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};a.prototype.addToMagnitude=function(x){x=x||0;var v=this.magnitude();var w=Math.sqrt((x+v)/v);this.x*=w;this.y*=w;this.z*=w;return this};a.prototype.unit=function(){return this.scale(1/this.magnitude())};a.prototype.rotateZ=function(v){var x=this.x;var w=this.y;this.x=x*Math.cos(v)-w*Math.sin(v);this.y=x*Math.sin(v)+w*Math.cos(v);return this};a.add=function(w,v){return new a(w.x+v.x,w.y+v.y,w.z+v.z)};a.subtract=function(w,v){return new a(w.x-v.x,w.y-v.y,w.z-v.z)};a.dot=function(w,v){return w.x*v.x+w.y*v.y+w.z*v.z};a.scale=function(w,x){return new a(w.x*x,w.y*x,w.z*x)};a.cross=function(w,v){return new a(w.y*v.z-v.y*w.z,w.z*v.x-v.z*w.x,w.x*v.y-v.x*w.y)};a.average=function(){var x,v=new a(),w=arguments;if(arguments[0].constructor.toString().indexOf("Array")!=-1){w=arguments[0]}x=w.length;for(i=0;i<x;i++){v.add(a.create(w[i]))}return v.scale(1/x)};a.create=function(v){return new a(v.x,v.y,v.z)};(function(y){var x=function(){return x};x.cssColor=function(z){if(z.length==3){return"rgb("+p(z[0])+","+p(z[1])+","+p(z[2])+")"}return"rgba("+p(z[0])+","+p(z[1])+","+p(z[2])+","+z[3]+")"};x.clamp=h=function(B,A,z){return(B<A?A:B>z?z:B)};x.opposite=function(A){if(!_.isArray(A)){A=x.parseColorString(A)}var z=x.rgb2hsl(A);z[0]=(z[0]+180)%360;z[1]=100-z[1];z[2]=100-z[2];var B=x.hsl2rgb(z);if(A.length===4){B.push(A[3])}return B};x.rgba2rgb=function(C){if(C.length===3||C[3]===255){return C}var E=C[0],D=C[1],z=C[2],A=C[3],B=[];B[0]=(A*E)+(255-A*255);B[1]=(A*D)+(255-A*255);B[2]=(A*z)+(255-A*255);return B};x.rgb2hex=function(z){z=x.rgba2rgb(z);return"#"+w(z[0])+w(z[1])+w(z[2])};x.hex2rgb=function(z){return x.parseColorString(z)};x.rgb2hsl=function(F){var z=F[0]/255,C=F[1]/255,G=F[2]/255,H=n(z,C,G),D=l(z,C,G),E,B,I,A=(H+D)/2;if(H==D){B=I=0}else{E=H-D;I=A>0.5?E/(2-H-D):E/(H+D);switch(n){case z:B=(C-G)/E+(C<G?6:0);break;case C:B=(G-z)/E+2;break;case G:B=(z-C)/E+4;break}B/=6}return[B,I*100,A*100]};x.hex2hsl=function(z){return x.rgb2hsl(x.hex2rgb(z))};x.hsl2rgb=function(F){var H,G,D;var z,C,E;var B=F[0],I=F[1]/100,A=F[2]/100;if(I==0){z=C=E=(A*255)}else{if(A<=0.5){G=A*(I+1)}else{G=A+I-A*I}H=A*2-G;D=B/360;z=v(H,G,D+1/3);C=v(H,G,D);E=v(H,G,D-1/3)}return[z,C,E]};function w(z){z=parseInt(z,10)||0;z=h(z,0,255).toString(16);if(z.length===1){z="0"+z}return z}function v(C,B,A){var z;if(A<0){A+=1}else{if(A>1){A-=1}}if(6*A<1){z=C+(B-C)*A*6}else{if(2*A<1){z=B}else{if(3*A<2){z=C+(B-C)*(2/3-A)*6}else{z=C}}}return 255*z}x.parseColorString=function(E){function I(N){var L=document.createElement("a");L.style.color=N;document.body.appendChild(L);var M=getComputedStyle(L).color;document.body.removeChild(L);return M}var F=false,z,C,G,H;E=I(E);var D=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,process:function(L){return[parseInt(L[1]),parseInt(L[2]),parseInt(L[3]),1]}},{re:/^rgba\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3}),\s*(\d*(\.\d+)?)\)$/,process:function(L){return[parseInt(L[1]),parseInt(L[2]),parseInt(L[3]),parseFloat(L[4])]}}];for(var B=0;B<D.length;B++){var K=D[B].re;var A=D[B].process;var J=K.exec(E);if(J){channels=A(J);z=channels[0];C=channels[1];G=channels[2];H=channels[3];F=true}}z=(z<0||isNaN(z))?0:((z>255)?255:z);C=(C<0||isNaN(C))?0:((C>255)?255:C);G=(G<0||isNaN(G))?0:((G>255)?255:G);H=(H<0||isNaN(H))?0:((H>1)?1:H);return F?[z,C,G,H]:[0,0,0,1]};y.util=x})(TeledrawCanvas);(function(){var w=0;var y=["ms","moz","webkit","o"];for(var v=0;v<y.length&&!window.requestAnimationFrame;++v){window.requestAnimationFrame=window[y[v]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[y[v]+"CancelAnimationFrame"]||window[y[v]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(C,z){var x=new Date().getTime();var A=Math.max(0,16-(x-w));var B=window.setTimeout(function(){C(x+A)},A);w=x+A;return B}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(x){clearTimeout(x)}}}());(function(y){y.canvases=[];var D=0;var x={tool:"pencil",alpha:255,color:[0,0,0],strokeSize:1000,strokeSoftness:0};var G={last:q,currentTool:q,previousTool:q,tool:q,mouseDown:k,mouseOver:k,width:q,height:q,currentZoom:1,currentOffset:{x:0,y:0},shadowOffset:5000,enableZoom:d,enableKeyboardShortcuts:d,enableWacomSupport:d,maxHistory:10,minStrokeSize:500,maxStrokeSize:10000,minStrokeSoftness:0,maxStrokeSoftness:100,maxZoom:8};var z;function C(){if(!z){var H;if(navigator.mimeTypes["application/x-wacomtabletplugin"]){H=document.createElement("embed");H.name=H.id="wacom-plugin";H.type="application/x-wacomtabletplugin"}else{H=document.createElement("object");H.classid="CLSID:092dfa86-5807-5a94-bf3b-5a53ba9e5308";H.codebase="fbWacomTabletPlugin.cab"}H.style.width=H.style.height="1px";H.style.top=H.style.left="-10000px";H.style.position="absolute";document.body.appendChild(H);z=H}}function E(){if(z&&z.penAPI){var H=z.penAPI.pressure;return H}}function A(){if(z&&z.penAPI){return parseInt(z.penAPI.pointerType)===3}}function F(J){var I=0;var H=0;while(J&&!isNaN(J.offsetLeft)&&!isNaN(J.offsetTop)){I+=J.offsetLeft;H+=J.offsetTop;J=J.offsetParent}return{top:H,left:I}}var w=typeof _Canvas!=="undefined"?_Canvas:function(H,I){var J=document.createElement("canvas");if(H){J.width=H}if(I){J.height=I}return J};var v=function(J,I){var H=this,K=H.element=J.getContext?J:document.getElementById(J);state=H.state=_.extend({},G,I);if(typeof(new w()).getContext!="function"){throw new Error("Error: Your browser does not support HTML canvas!");return false}if(state.enableWacomSupport){C()}K.width=state.width=state.displayWidth||state.width||K.width;K.height=state.height=state.displayHeight||state.height||K.height;state.fullWidth=state.fullWidth||state.width;state.fullHeight=state.fullHeight||state.height;if(state.width/state.height!==state.fullWidth/state.fullHeight){state.fullHeight=state.fullWidth*state.height/state.width}H._displayCanvas=K;if(state.enableZoom){H._canvas=new w(state.fullWidth,state.fullHeight)}else{H._canvas=K}H.history=new y.History(H);H.defaults();H.zoom(0);H.history.checkpoint();y.canvases[D++]=H;H.bindEvents()};var B=v.prototype;B.bindEvents=function(){var Q=this,I=Q.element,L=Q.state,R,O=q,H=0,Z=0;m(I,"gesturestart",X);m(I,"gesturechange",S);m(I,"gestureend",M);m(I,"dblclick",T);m(I,"mouseenter",W);m(I,"mousedown",Y);m(I,"touchstart",Y);m(I,"mouseleave",N);m(window,"mousemove",J);m(window,"touchmove",J);m(window,"keydown",U);m(window,"keyup",P);Q.unbindEvents=function(){o(I,"gesturestart",X);o(I,"gesturechange",S);o(I,"gestureend",M);o(I,"dblclick",T);o(I,"mouseenter",W);o(I,"mousedown",Y);o(I,"touchstart",Y);o(I,"mouseleave",N);o(window,"mousemove",J);o(window,"touchmove",J);o(window,"keydown",U);o(window,"keyup",P)};function W(aa){var ab=K(aa);L.tool.enter(L.mouseDown,ab);L.last=ab;L.mouseOver=d}function N(aa){var ab=K(aa);L.tool.leave(L.mouseDown,ab);L.mouseOver=k}function T(aa){var ab=K(aa);L.tool.dblclick(ab)}function P(aa){L.tool.keyup(L.mouseDown,aa.keyCode)}function U(ab){L.tool.keydown(L.mouseDown,ab.keyCode);if(!L.enableKeyboardShortcuts){return}var aa=document.activeElement.nodeName.toLowerCase();if(aa==="input"||aa==="textarea"){return}else{switch(ab.keyCode){case 69:Q.setTool("eraser");break;case 70:Q.setTool("fill");break;case 71:Q.setTool("grab");break;case 73:Q.setTool("eyedropper");break;case 76:Q.setTool("line");break;case 79:Q.setTool("ellipse");break;case 80:Q.setTool("pencil");break;case 82:Q.setTool("rectangle");break;case 90:if(L.mouseDown){return false}if(ab.metaKey||ab.ctrlKey){if(ab.shiftKey){Q.redo()}else{Q.undo()}return false}break;case 189:if(ab.shiftKey){Q.setStrokeSize(L.strokeSize-500)}break;case 187:if(ab.shiftKey){Q.setStrokeSize(L.strokeSize+500)}break;case 188:if(ab.shiftKey){Q.setAlpha(L.globalAlpha-0.1)}break;case 190:if(ab.shiftKey){Q.setAlpha(L.globalAlpha+0.1)}break;case 219:if(ab.shiftKey){Q.setStrokeSoftness(L.strokeSoftness-10)}break;case 221:if(ab.shiftKey){Q.setStrokeSoftness(L.strokeSoftness+10)}break}}}function J(ab){if(Date.now()-H<25){return k}H=Date.now();if(ab.type=="touchmove"&&ab.touches.length>1){return d}if(O=="touchmove"&&ab.type=="mousemove"){return}if(ab.target==I||L.mouseDown){var aa=K(ab);L.tool.move(L.mouseDown,L.last,aa);L.last=aa;Q.trigger("mousemove",aa,ab);O=ab.type;ab.preventDefault();return k}}function Y(ab){var aa=L.last=K(ab);if(ab.type=="touchstart"&&ab.touches.length>1){return d}m(window,ab.type==="mousedown"?"mouseup":"touchend",V);L.mouseDown=d;if(L.enableWacomSupport&&A()&&L.currentTool!=="eraser"){Q.setTool("eraser");L.wacomWasEraser=d}L.tool.down(aa);Q.trigger("mousedown",aa,ab);document.onselectstart=function(){return k};ab.preventDefault();return k}function V(aa){o(window,aa.type==="mouseup"?"mouseup":"touchend",V);if(aa.type=="touchend"&&aa.touches.length>1){return d}L.mouseDown=k;L.tool.up(L.last);Q.trigger("mouseup",L.last,aa);if(L.wacomWasEraser===d){Q.previousTool();L.wacomWasEraser=k}document.onselectstart=function(){return d};aa.preventDefault();return k}function X(aa){if(L.tool.name=="grab"){R=L.currentZoom}}function S(aa){if(L.tool.name=="grab"){var ab=L.last;Q.zoom(R*aa.scale,ab.xd,ab.yd)}aa.preventDefault();return k}function M(aa){}function K(ad){var ae=F(I),ab=ad.pageX||ad.touches&&ad.touches[0].pageX,aa=ad.pageY||ad.touches&&ad.touches[0].pageY,ac=null;if(L.enableWacomSupport){if(Date.now()-Z>25){Z=Date.now();ac=E()}}return{x:p((ab-ae.left)/L.currentZoom)+L.currentOffset.x||0,y:p((aa-ae.top)/L.currentZoom)+L.currentOffset.y||0,xd:p(ab-ae.left)||0,yd:p(aa-ae.top)||0,p:ac}}};B.setRGBAArrayColor=function(I){var J=this.state;if(I.length===4){J.globalAlpha=I.pop()}for(var H=I.length;H<3;++H){I.push(0)}J.color=I;this.updateTool()};B.updateTool=function(){var H=1+p(c(this.state.strokeSize/1000,2));var I=p(c(this.state.strokeSoftness,1.3)/300*H);this.state.lineWidth=H;this.state.shadowBlur=I};B.updateDisplayCanvas=function(K){if(this.state.enableZoom===false){return this}var O=this.displayCtx(),N=this.state.currentOffset,L=this.state.currentZoom,I=O.canvas.width,M=O.canvas.height,H=p(I/L),J=p(M/L);O.clearRect(0,0,I,M);if(K!==true){this.trigger("display.update:before")}O.drawImage(this._canvas,N.x,N.y,H,J,0,0,I,M);if(K!==true){this.trigger("display.update:after")}};B.canvas=function(){return this._canvas};B.ctx=function(){return this._ctx||(this._ctx=this._canvas.getContext("2d"))};B.displayCanvas=function(){return this._displayCanvas};B.displayCtx=function(){return this._displayCtx||(this._displayCtx=this._displayCanvas.getContext("2d"))};B.destroy=function(){this.unbindEvents()};B.cursor=function(I){if(!I){I="default"}var H=I.split(/,\s*/);do{I=H.shift();this.element.style.cursor=I}while(I.length&&this.element.style.cursor!=I);return this};B.clear=function(J){var I=this,H=I.ctx();H.clearRect(0,0,H.canvas.width,H.canvas.height);if(J!==d){I.history.checkpoint()}I.updateDisplayCanvas();return I};B.defaults=function(){var H=this;H.setTool("pencil");H.setAlpha(x.alpha);H.setColor(x.color);H.setStrokeSize(x.strokeSize);H.setStrokeSoftness(x.strokeSoftness);return H};B.toDataURL=function(H,L,J,K){if(J&&K){J=parseInt(J);K=parseInt(K);H=H!==u?H:0;L=L!==u?L:0;var I=this.getTempCanvas(J,K);I.getContext("2d").drawImage(this.canvas(),H,L,J,K,0,0,J,K);return I.toDataURL()}return this.canvas().toDataURL()};B.getTempCanvas=function(H,I){return new w(H||this._canvas.width,I||this._canvas.height)};B.fromDataURL=B.fromImageURL=function(K,H){var J=this,I=new Image();I.onload=function(){J.clear(d);J.ctx().drawImage(I,0,0);J.updateDisplayCanvas();if(typeof H=="function"){H.call(J)}};I.src=K;return J};B.isBlank=function(){var K=this.getImageData().data;var H=K.length;for(var J=0,I=H;J<I;++J){if(K[J]!==0){return false}}return true};B.fromImage=B.fromVideo=B.fromCanvas=function(H){this.clear(d);this.ctx().drawImage(H,0,0);this.updateDisplayCanvas();return this};B.getImageData=function(){var H=this.ctx();return H.getImageData(0,0,H.canvas.width,H.canvas.height)};B.putImageData=function(H){this.ctx().putImageData(H,0,0);this.updateDisplayCanvas();return this};B.getColor=function(){return this.state.color.slice()};B.setColor=function(H){if(!_.isArray(H)){H=y.util.parseColorString(H)}this.setRGBAArrayColor(H);return this};B.setAlpha=function(H){this.state.globalAlpha=h(H,0,1);return this};B.getAlpha=function(){return this.state.globalAlpha};B.setStrokeSize=function(H){this.state.strokeSize=h(H,this.state.minStrokeSize,this.state.maxStrokeSize);this.updateTool();return this};B.setStrokeSoftness=function(H){this.state.strokeSoftness=h(H,this.state.minStrokeSoftness,this.state.maxStrokeSoftness);this.updateTool();return this};B.setTool=function(H){if(this.state.currentTool===H){return this}this.state.previousTool=this.state.currentTool;this.state.currentTool=H;if(!y.tools[H]){throw new Error('Tool "'+H+'" not defined.')}this.state.tool=new y.tools[H](this);this.updateTool();return this};B.previousTool=function(){return this.setTool(this.state.previousTool)};B.undo=function(){this.history.undo();return this};B.redo=function(){this.history.redo();return this};B.resize=function(I,K){if(this.state.enableZoom===false){return this}var J=this,H=Math.round(J._canvas.width/J._canvas.height*100)/100,L=Math.round(I/K*100)/100;if(H!==L){throw new Error("Not the same aspect ratio!")}J._displayCanvas.width=J.state.width=I;J._displayCanvas.height=J.state.height=K;return J.zoom(J.state.currentZoom)};B.zoom=function(K,M,L){if(arguments.length===0){return this.state.currentZoom}if(this.state.enableZoom===false){return this}var O=this,J=0,I=0,N=O.state.currentZoom,P=O._displayCanvas.width,H=O._displayCanvas.height;M=h(M||P/2,0,P);L=h(L||H/2,0,H);K=h(K||0,P/O._canvas.width,O.state.maxZoom);if(K!==N){if(K>N){J=-(P/N-P/K)/2-(M-P/2)/N;I=-(H/N-H/K)/2-(L-H/2)/N}else{if(K<N){J=(P/K-P/N)/2;I=(H/K-H/N)/2}}J*=K;I*=K}O.state.currentZoom=K;O.trigger("zoom",K,N);O.pan(J,I);O.updateDisplayCanvas();return O};B.pan=function(K,J,L){if(arguments.length===0){return this.state.currentOffset}if(this.state.enableZoom===false){return this}var P=this,O=P.state.currentZoom,I=P.state.currentOffset.x,H=P.state.currentOffset.y,N=P._canvas.width-p(P._displayCanvas.width/O),M=P._canvas.height-p(P._displayCanvas.height/O);K=L===d?K/O:I-(K||0)/O;J=L===d?J/O:H-(J||0)/O;K=p(h(K,0,N));J=p(h(J,0,M));P.state.currentOffset={x:K,y:J};P.trigger("pan",P.state.currentOffset);P.updateDisplayCanvas();return P};_.extend(B,Events);y.api=v})(TeledrawCanvas);(function(w){var v=function(x){this.canvas=x;this.rev=0;this.clear()};v.prototype.clear=function(){this.past=[];this.current=null;this.future=[]};v.prototype.checkpoint=function(){if(this.past.length>this.canvas.state.maxHistory){this.past.shift().destroy()}if(this.current){this.past.push(this.current)}this.current=new w.Snapshot(this.canvas);this.future=[];this.rev++};v.prototype.undo=function(){if(this._move(this.past,this.future)){this.rev--}};v.prototype.redo=function(){if(this._move(this.future,this.past)){this.rev++}};v.prototype._move=function(y,x){if(!y.length){return k}if(!this.current){return k}x.push(this.current);this.current=y.pop();this.current.restore();return d};w.History=v})(TeledrawCanvas);(function(w){var v=function(x){this.canvas=x;if(!this.canvas._snapshotBuffers){this.canvas._snapshotBuffers=[]}this._snapshotBufferCanvas()};v.prototype.restore=function(z){var x,y;if(z){x=z.tl;y=z.br}else{x={x:0,y:0};y={x:this.canvas.canvas().width,y:this.canvas.canvas().height}}this._restoreBufferCanvas(x,y);this.canvas.updateDisplayCanvas(false,x,y)};v.prototype.destroy=function(){this._putBufferCtx()};v.prototype.toDataURL=function(){return this.buffer&&this.buffer.toDataURL()};v.prototype._snapshotBufferCanvas=function(){this._getBufferCtx();this.buffer.drawImage(this.canvas.canvas(),0,0)};v.prototype._restoreBufferCanvas=function(z,A){var y=this.canvas.ctx();var x=A.x-z.x,B=A.y-z.y;if(x===0||B===0){return}y.clearRect(z.x,z.y,x,B);y.drawImage(this.buffer.canvas,z.x,z.y,x,B,z.x,z.y,x,B)};v.prototype._snapshotImageData=function(){this.data=this.canvas.getImageData()};v.prototype._restoreImageData=function(){this.canvas.putImageData(this.data)};v.prototype._putBufferCtx=function(){if(this.buffer){this.canvas._snapshotBuffers.push(this.buffer)}this.buffer=null};v.prototype._getBufferCtx=function(){var x;if(!this.buffer){if(this.canvas._snapshotBuffers.length){x=this.canvas._snapshotBuffers.pop();x.clearRect(0,0,x.canvas.width,x.canvas.height)}else{x=this.canvas.getTempCanvas().getContext("2d")}}this.buffer=x};w.Snapshot=v})(TeledrawCanvas);(function(w){var v=function(x){this.canvas=x};v.prototype.start=function(x){};v.prototype.move=function(y,x){};v.prototype.end=function(){};v.prototype.draw=function(){};v.prototype.save=function(){this.snapshot=new w.Snapshot(this.canvas)};v.prototype.restore=function(){this.snapshot.restore(this)};v.prototype.destroy=function(){this.snapshot.destroy()};w.Stroke=v})(TeledrawCanvas);(function(w){var v=function(){};v.prototype.down=function(x){};v.prototype.up=function(x){};v.prototype.move=function(x,z,y){};v.prototype.dblclick=function(x){};v.prototype.enter=function(x,y){};v.prototype.leave=function(x,y){};v.prototype.keydown=function(x,y){if(y===16){this.shiftKey=true;if(x){this._updateBoundaries({});this.draw()}}};v.prototype.keyup=function(x,y){if(y===16){this.shiftKey=false;if(x){this._updateBoundaries({});this.draw()}}};v.prototype.preview=function(){};v.prototype.alt_down=function(){};v.prototype.alt_up=function(){};v.createTool=function(y,B,z){var A=function(C){this.canvas=C;this.ctx=C.ctx();this.color=C.getColor();this.color.push(C.getAlpha());this.points=[];this.tl={x:this.ctx.canvas.width,y:this.ctx.canvas.height};this.br={x:0,y:0};this.tool={}};A.prototype=new w.Stroke();var x=function(C){this.canvas=C;C.cursor(B);this.name=y;this.cursor=B||"default";this.currentStroke=null;if(typeof z=="function"){z.call(this)}};x.prototype=new v();x.prototype.down=function(C){this.currentStroke=new A(this.canvas);this.currentStroke.tool=this;this.currentStroke.save();this.currentStroke.points.push(C);this.currentStroke.start(C);this._updateBoundaries(C);this.draw()};x.prototype.move=function(C,E,D){if(C&&this.currentStroke){this.currentStroke.points.push(D);this.currentStroke.move(E,D);this._updateBoundaries(D);this.draw()}};x.prototype.up=function(C){if(this.currentStroke){this.currentStroke.end(C);this.draw();this.currentStroke.destroy();this.currentStroke=null;this.canvas.history.checkpoint()}this.canvas.trigger("tool.up")};x.prototype.draw=function(){this.currentStroke.ctx.save();this.currentStroke.restore();this.currentStroke.draw();this.canvas.updateDisplayCanvas(false,this.currentStroke.tl,this.currentStroke.br);this.currentStroke.ctx.restore()};x.prototype._updateBoundaries=function(F){var E=this.currentStroke,C=E.ctx.canvas,D=this.canvas.state.shadowBlur+this.canvas.state.lineWidth;if(this.shiftKey){E.tl.x=E.tl.y=0;E.br.x=C.width;E.br.y=C.height;return}if(F.x-D<E.tl.x){E.tl.x=h(p(F.x-D),0,C.width)}if(F.x+D>E.br.x){E.br.x=h(p(F.x+D),0,C.width)}if(F.y-D<E.tl.y){E.tl.y=h(p(F.y-D),0,C.height)}if(F.y+D>E.br.y){E.br.y=h(p(F.y+D),0,C.height)}};x.stroke=A;A.tool=x;w.tools[y]=x;return x};w.Tool=v;w.tools={}})(TeledrawCanvas);(function(y){var v=y.Tool.createTool("ellipse","crosshair"),w=v.stroke.prototype;w.bgColor=[255,255,255];w.bgAlpha=0;w.lineWidth=1;w.start=function(z){this.first=z};w.move=function(A,z){this.second=z};w.end=function(z){this.second=z};w.draw=function(){if(!this.first||!this.second){return}var H=this,F=H.first.x,E=H.first.y,G=H.second.x-F,C=H.second.y-E,I=H.ctx,z=H.canvas.state,J=z.shadowOffset,B=z.shadowBlur,D=z.lineWidth,A=y.util.cssColor(z.color);I.lineJoin=I.lineCap="round";I.globalAlpha=z.globalAlpha;I.fillStyle=I.strokeStyle=A;I.miterLimit=100000;if(H.tool.shiftKey){C=H.second.y>E?j(G):-j(G)}if(H.tool.fill){x(I,F,E,G,C);I.fill()}else{if(B>0){I.shadowColor=A;I.shadowOffsetX=I.shadowOffsetY=J;I.shadowBlur=B;I.translate(-J,-J)}I.lineWidth=D;x(I,F,E,G,C);I.stroke()}};function x(B,z,E,A,C){var D=0.5522848;ox=(A/2)*D,oy=(C/2)*D,xe=z+A,ye=E+C,xm=z+A/2,ym=E+C/2;B.beginPath();B.moveTo(z,ym);B.bezierCurveTo(z,ym-oy,xm-ox,E,xm,E);B.bezierCurveTo(xm+ox,E,xe,ym-oy,xe,ym);B.bezierCurveTo(xe,ym+oy,xm+ox,ye,xm,ye);B.bezierCurveTo(xm-ox,ye,z,ym+oy,z,ym);B.closePath()}})(TeledrawCanvas);(function(w){var v=w.Tool.createTool("eraser","crosshair");v.stroke.prototype.lineWidth=1;v.stroke.prototype.lineCap="round";v.stroke.prototype.draw=function(){this.color=[255,255,255,255];this.ctx.globalCompositeOperation="destination-out";w.tools.pencil.stroke.prototype.draw.call(this)}})(TeledrawCanvas);(function(x){var v=function(){this.previewContainer=document.createElement("div");_.extend(this.previewContainer.style,{position:"absolute",width:"10px",height:"10px",border:"1px solid black",display:"none"});document.body.appendChild(this.previewContainer);if(this.canvas.state.mouseOver){this.previewContainer.style.display="block"}};var w=x.Tool.createTool("eyedropper","crosshair",v);w.prototype.pick=function(C){var z=this.previewContainer,D,B=this.canvas.element.offsetLeft,A=this.canvas.element.offsetTop,y=this.canvas._displayCtx.getImageData(C.xd,C.yd,1,1).data;this.color=x.util.rgba2rgb(Array.prototype.slice.call(y));var D=x.util.rgb2hsl(this.color)[2];_.extend(z.style,{left:(B+C.xd+15)+"px",top:(A+C.yd+5)+"px",background:x.util.cssColor(this.color),"border-color":D>=50?"#000":"#888"});if(this.canvas.state.mouseOver){z.style.display="none";z.offsetHeight;z.style.display="block"}else{z.style.display="none"}};w.prototype.enter=function(){this.previewContainer.style.display="block"};w.prototype.leave=function(){this.previewContainer.style.display="none"};w.prototype.move=function(A,z,y){this.pick(y)};w.prototype.down=function(y){this.pick(y)};w.prototype.up=function(y){this.pick(y);this.canvas.setColor(this.color);this.previewContainer.parentNode.removeChild(this.previewContainer);this.canvas.previousTool()}})(TeledrawCanvas);(function(C){var x=C.Tool.createTool("fill","crosshair");var v=Math.abs;x.blur=true;x.stroke.prototype.bgColor=[255,255,255];x.stroke.prototype.bgAlpha=255;x.stroke.prototype.end=function(I){var M=this.ctx.canvas.width,H=this.ctx.canvas.height;var E=this.ctx.getImageData(0,0,M,H);var J=this.ctx.createImageData(M,H);var F=this.color;F[3]*=255;B(E.data,J.data,I,M,H,this.color);this.tmp_canvas=this.canvas.getTempCanvas();var L=this.tmp_canvas.getContext("2d");L.putImageData(J,0,0);if(x.blur){stackBlurCanvasRGBA(this.tmp_canvas,1);var K=L.getImageData(0,0,M,H);for(var G=0,D=K.data.length;G<D;G+=4){if(K.data[G+3]/255>0.2){K.data[G]=F[0];K.data[G+1]=F[1];K.data[G+2]=F[2];K.data[G+3]=Math.min(F[3],K.data[G+3]*3)}}L.putImageData(K,0,0)}};x.stroke.prototype.draw=function(){if(this.tmp_canvas){this.ctx.drawImage(this.tmp_canvas,0,0)}};function B(G,F,U,M,T,N){var H=[[U.x,U.y]];var O=z(G,U.x,U.y,M);var S=x.tolerance;var I,D;var R,Q,P,L,J,E;var K=C.util.opposite(O);K[3]/=2;while(H.length){P=H.pop();L=P[0];E=J=P[1];while(E>=0&&y(z(G,L,E,M),O)){E--}E++;I=D=false;while(E<T&&y(z(G,L,E,M),O)){w(G,L,E,M,K);w(F,L,E,M,N);if(!I&&L>0&&y(z(G,L-1,E,M),O)){H.push([L-1,E]);I=true}else{if(I&&L>0&&y(z(G,L-1,E,M),O)){I=false}}if(!D&&L<M-1&&y(z(G,L+1,E,M),O)){H.push([L+1,E]);D=true}else{if(D&&L<M-1&&y(z(G,L+1,E,M),O)){D=false}}E++}}}function z(F,D,H,E){var G=(H*E+D)*4;return[F[G],F[G+1],F[G+2],F[G+3]]}function w(G,D,I,E,F){var H=(I*E+D)*4;G[H]=F[0];G[H+1]=F[1];G[H+2]=F[2];G[H+3]=F[3]}function A(E,D){return v(E[0]-D[0])+v(E[1]-D[1])+v(E[2]-D[2])+v(E[3]-D[3])}function y(E,D){return A(E,D)<5}})(TeledrawCanvas);(function(y){var w="hand, grab, -moz-grab, -webkit-grab, move",v="grabbing, -moz-grabbing, -webkit-grabbing, move";var x=y.Tool.createTool("grab",w);x.prototype.move=function(C,B,A){var z=this;if(C){clearTimeout(this._clearDeltasId);cancelAnimationFrame(this._momentumId);this.dx=A.xd-B.xd;this.dy=A.yd-B.yd;this.canvas.pan(this.dx,this.dy);this._clearDeltasId=setTimeout(function(){z.dx=z.dy=0},100)}};x.prototype.down=function(z){cancelAnimationFrame(this._momentumId);this.canvas.cursor(v)};x.prototype.up=function(z){cancelAnimationFrame(this._momentumId);this.momentum(this.dx,this.dy);this.dx=this.dy=0;this.canvas.cursor(w)};x.prototype.dblclick=function(A){cancelAnimationFrame(this._momentumId);this.dx=this.dy=0;var z=2;if(this.shiftKey){z/=4}this.canvas.zoom(this.canvas.state.currentZoom*z,A.xd,A.yd)};x.prototype.momentum=function(B,z){var A=this;if(Math.abs(B)>=1||Math.abs(z)>=1){B/=1.1;z/=1.1;this.canvas.pan(B,z);this._momentumId=requestAnimationFrame(function(){A.momentum(B,z)})}}})(TeledrawCanvas);(function(w){var v=w.Tool.createTool("line","crosshair");v.stroke.prototype.lineWidth=1;v.stroke.prototype.lineCap="round";v.stroke.prototype.bgColor=[255,255,255];v.stroke.prototype.bgAlpha=0;v.stroke.prototype.start=function(x){this.first=x};v.stroke.prototype.move=function(y,x){this.second=x};v.stroke.prototype.end=function(x){this.second=x};v.stroke.prototype.draw=function(){if(!this.first||!this.second){return}var D=_.extend({},this.first),B=_.extend({},this.second),A,z,E,C=Math.PI;delete D.p;delete B.p;if(this.tool.shiftKey){z=B.x-D.x;E=B.y-D.y;A=Math.atan2(E,z);if((A>=-C*7/8&&A<-C*5/8)||(A>=-C*3/8&&A<-C/8)){B.y=D.y-Math.abs(z)}else{if((A>=-C*5/8&&A<-C*3/8)||(A>=C*3/8&&A<C*5/8)){B.x=D.x}else{if((A>=C/8&&A<C*3/8)||(A>=C*5/8&&A<C*7/8)){B.y=D.y+Math.abs(z)}else{B.y=D.y}}}}this.points=[D,B];w.tools.pencil.stroke.prototype.draw.call(this)}})(TeledrawCanvas);(function(A){var v=A.Tool.createTool("pencil","crosshair");v.stroke.prototype.lineWidth=1;v.stroke.prototype.lineCap="round";v.stroke.prototype.smoothing=true;v.stroke.prototype.draw=function(){var H=this.canvas.state,E=this.ctx,G=this.points,D=H.shadowOffset,C=H.shadowBlur,B=H.lineWidth,F=A.util.cssColor(H.color);E.globalAlpha=H.globalAlpha;E.fillStyle=E.strokeStyle=F;E.miterLimit=100000;if(C>0){E.shadowColor=F;E.shadowOffsetX=E.shadowOffsetY=D;E.shadowBlur=C;E.translate(-D,-D)}if(G.length===1){switch(this.lineCap){case"round":E.beginPath();if(G[0].p){B*=G[0].p*2}E.arc(G[0].x,G[0].y,B/2,0,2*Math.PI,true);E.closePath();E.fill();break;case"square":E.fillRect(G[0].x-B/2,G[0].y-B/2,B,B)}}else{if(G.length>1){E.lineJoin="round";E.lineCap=this.lineCap;E.lineWidth=B;if(G[0].p||G[1].p){E.beginPath();y(E,z(G,B),this.smoothing);E.closePath();E.fill()}else{E.beginPath();y(E,G,this.smoothing);E.stroke()}}}};function z(M,I){var N={left:[],right:[]},H=M.length,B=M[0],J=new a(B.x,B.y),C,L,D,K,G;for(var F=1,E=H;F<E;++F){C=M[F];if(C.x===B.x&&C.y===B.y){continue}L=new a(C.x,C.y);D=a.subtract(L,J).unit().rotateZ(Math.PI/2);K=a.subtract(L,J).unit().rotateZ(-Math.PI/2);G=a(D).scale(B.p*I).add(J);N.left.push({x:G.x,y:G.y});G=a(K).scale(B.p*I).add(J);N.right.unshift({x:G.x,y:G.y});B=C;J=L}G=a(D).scale(B.p*I).add(J);N.left.push({x:G.x,y:G.y});G=a(K).scale(B.p*I).add(J);N.right.unshift({x:G.x,y:G.y});result=N.left.concat(N.right);result.push(N.left[0]);return result}function y(J,I,E){if(I.length===0){return}J.moveTo(I[0].x,I[0].y);var C=I[0],G=null,K=C,F=I.length;for(var D=1,B=F;D<B;++D){K=I[D];if(G&&(G.x==K.x||G.y==K.y)){K.x+=0.1;K.y+=0.1}if(E){var H={x:(C.x+K.x)/2,y:(C.y+K.y)/2};J.quadraticCurveTo(C.x,C.y,H.x,H.y)}else{J.lineTo(K.x,K.y)}G=C;C=I[D]}if(E){J.quadraticCurveTo(C.x,C.y,K.x,K.y)}}function x(C,B){return t(g(C.x-B.x)+g(C.y-B.y))}function w(C){var F=0,B=C.length;for(var E=0,D=B;E<D;E++){F+=+C[E]}return F/B}})(TeledrawCanvas);(function(x){var w=x.Tool.createTool("rectangle","crosshair");w.stroke.prototype.bgColor=[255,255,255];w.stroke.prototype.bgAlpha=0;w.stroke.prototype.lineWidth=1;w.stroke.prototype.start=function(y){this.first=y};w.stroke.prototype.move=function(z,y){this.second=y};w.stroke.prototype.end=function(y){this.second=y};w.stroke.prototype.draw=function(){if(!this.first||!this.second){return}var C=this.first,z=_.extend({},this.second),F=this.ctx,y=this.canvas.state,G=y.shadowOffset,B=y.shadowBlur,D=y.lineWidth,A=x.util.cssColor(y.color);F.lineJoin=F.lineCap="round";F.globalAlpha=y.globalAlpha;F.fillStyle=F.strokeStyle=A;F.miterLimit=100000;if(this.tool.shiftKey){var E=Math.abs(z.x-C.x);z.y=C.y+(z.y>C.y?E:-E)}if(this.tool.fill){v(F,C,z);F.fill()}else{if(B>0){F.shadowColor=A;F.shadowOffsetX=F.shadowOffsetY=G;F.shadowBlur=B;F.translate(-G,-G)}F.lineWidth=D;v(F,C,z);F.stroke()}};function v(y,A,z){y.beginPath();y.moveTo(A.x,A.y);y.lineTo(z.x,A.y);y.lineTo(z.x,z.y);y.lineTo(A.x,z.y);y.lineTo(A.x,A.y)}})(TeledrawCanvas)})();